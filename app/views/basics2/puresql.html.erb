<h1>Pure SQL</h1>
<hr>
<h3>Point 7</h3>
<p>
  admin1=# \d<br>            List of relations<br> Schema |     Name      | Type  | Owner  <br>--------+---------------+-------+--------<br> public | mailing_list  | table | admin1<br> public | phone_numbers | table | admin1<br>(2 rows)<br><br>admin1=# \d mailing_list<br>         Table "public.mailing_list"<br> Column |          Type          | Modifiers <br>--------+------------------------+-----------<br> email  | character varying(100) | not null<br> name   | character varying(100) | <br>Indexes:<br>    "mailing_list_pkey" PRIMARY KEY, btree (email)<br>Referenced by:<br>    TABLE "phone_numbers" CONSTRAINT "phone_numbers_email_fkey" FOREIGN KEY (email) REFERENCES mailing_list(email)<br><br>admin1=# \d admin1<br>Did not find any relation named "admin1".<br>admin1=# create table my_stocks (symbol varchar(20) not null, n_shares integer not null, date_acquired date not null );<br>CREATE TABLE<br>admin1=# \d<br>            List of relations<br> Schema |     Name      | Type  | Owner  <br>--------+---------------+-------+--------<br> public | mailing_list  | table | admin1<br> public | my_stocks     | table | admin1<br> public | phone_numbers | table | admin1<br>(3 rows)<br><br>admin1=# \d my_stocks <br>             Table "public.my_stocks"<br>    Column     |         Type          | Modifiers <br>---------------+-----------------------+-----------<br> symbol        | character varying(20) | not null<br> n_shares      | integer               | not null<br> date_acquired | date                  | not null<br><br>admin1=# <br>admin1=# select * from my_stocks <br>admin1-# ;<br> symbol | n_shares | date_acquired <br>--------+----------+---------------<br>(0 rows)<br><br>admin1=# <br>admin1=# COPY my_stocks FROM '/home/admin1/Documents/ps2/stockdata.txt' DELIMITER ',' CSV;<br>COPY 5<br>admin1=# select * from my_stocks ;<br>  symbol  | n_shares | date_acquired <br>----------+----------+---------------<br> IBM      |     1000 | 2016-01-01<br> ibm      |     1000 | 2016-01-01<br> apple    |     1000 | 2016-01-01<br> google   |     1000 | 2016-01-01<br> ALPHABET |     1000 | 2016-01-01<br>(5 rows)<br><br>admin1=#
</p>
<hr>
<h3>Point 8</h3>
<p>
  admin1=# \d<br>            List of relations<br> Schema |     Name      | Type  | Owner  <br>--------+---------------+-------+--------<br> public | mailing_list  | table | admin1<br> public | my_stocks     | table | admin1<br> public | phone_numbers | table | admin1<br> public | stock_prices  | table | admin1<br>(4 rows)<br><br>admin1=# select symbol from my_stocks ;<br>  symbol  <br>----------<br> IBM<br> ibm<br> apple<br> google<br> ALPHABET<br>(5 rows)<br><br>admin1=# select symbol, '22/03/02' as date, 33.415 as price  from my_stocks ;<br>  symbol  |   date   | price  <br>----------+----------+--------<br> IBM      | 22/03/02 | 33.415<br> ibm      | 22/03/02 | 33.415<br> apple    | 22/03/02 | 33.415<br> google   | 22/03/02 | 33.415<br> ALPHABET | 22/03/02 | 33.415<br>(5 rows)<br><br>admin1=# select symbol, current_date as date, 33.415 as price  from my_stocks ;<br>  symbol  |    date    | price  <br>----------+------------+--------<br> IBM      | 2016-08-31 | 33.415<br> ibm      | 2016-08-31 | 33.415<br> apple    | 2016-08-31 | 33.415<br> google   | 2016-08-31 | 33.415<br> ALPHABET | 2016-08-31 | 33.415<br>(5 rows)<br><br>admin1=# \d<br>            List of relations<br> Schema |     Name      | Type  | Owner  <br>--------+---------------+-------+--------<br> public | mailing_list  | table | admin1<br> public | my_stocks     | table | admin1<br> public | phone_numbers | table | admin1<br> public | stock_prices  | table | admin1<br>(4 rows)<br><br>admin1=# select * from stock_prices ;<br> symbol | quote_date | price <br>--------+------------+-------<br>(0 rows)<br><br>admin1=# insert into stock_prices values (select symbol, current_date, 33.415 from my_stocks) ;<br>ERROR:  syntax error at or near "select"<br>LINE 1: insert into stock_prices values (select symbol, current_date...<br>                                         ^<br>admin1=# insert into stock_prices values (select symbol, current_date, 33.415 from my_stocks) ;<br>ERROR:  syntax error at or near "select"<br>LINE 1: insert into stock_prices values (select symbol, current_date...<br>                                         ^<br>admin1=# \dt stock_prices <br>           List of relations<br> Schema |     Name     | Type  | Owner  <br>--------+--------------+-------+--------<br> public | stock_prices | table | admin1<br>(1 row)<br><br>admin1=# \d stock_prices <br>          Table "public.stock_prices"<br>   Column   |         Type          | Modifiers <br>------------+-----------------------+-----------<br> symbol     | character varying(20) | not null<br> quote_date | date                  | not null<br> price      | double precision      | <br><br>admin1=# insert into stock_prices(symbol, quote_date, price) values (select symbol, current_date, 33.415 from my_stocks) ;<br>ERROR:  syntax error at or near "select"<br>LINE 1: ...o stock_prices(symbol, quote_date, price) values (select sym...<br>                                                             ^<br>admin1=# insert into stock_prices select symbol, current_date, 33.415 from my_stocks ;<br>INSERT 0 5<br>admin1=# select * from stock_prices ;<br>  symbol  | quote_date | price  <br>----------+------------+--------<br> IBM      | 2016-08-31 | 33.415<br> ibm      | 2016-08-31 | 33.415<br> apple    | 2016-08-31 | 33.415<br> google   | 2016-08-31 | 33.415<br> ALPHABET | 2016-08-31 | 33.415<br>(5 rows)<br><br>admin1=# <br><br>admin1=# create table newly_acquired_stocks(symbol varchar(20) not null, n_shares integer not null, date_acquired date not null);<br>CREATE TABLE<br>admin1=# \d stock_prices <br>          Table "public.stock_prices"<br>   Column   |         Type          | Modifiers <br>------------+-----------------------+-----------<br> symbol     | character varying(20) | not null<br> quote_date | date                  | not null<br> price      | double precision      | <br><br>admin1=# \dt<br>                List of relations<br> Schema |         Name          | Type  | Owner  <br>--------+-----------------------+-------+--------<br> public | mailing_list          | table | admin1<br> public | my_stocks             | table | admin1<br> public | newly_acquired_stocks | table | admin1<br> public | phone_numbers         | table | admin1<br> public | stock_prices          | table | admin1<br>(5 rows)<br><br>admin1=# \d newly_acquired_stocks <br>       Table "public.newly_acquired_stocks"<br>    Column     |         Type          | Modifiers <br>---------------+-----------------------+-----------<br> symbol        | character varying(20) | not null<br> n_shares      | integer               | not null<br> date_acquired | date                  | not null<br><br>admin1=# select * from m<br>mailing_list  my_stocks     <br>admin1=# select * from my_stocks limit 3<br>admin1-# ;<br> symbol | n_shares | date_acquired <br>--------+----------+---------------<br> IBM    |     1000 | 2016-01-01<br> ibm    |     1000 | 2016-01-01<br> apple  |     1000 | 2016-01-01<br>(3 rows)<br><br>admin1=# select * from my_stocks ;<br>  symbol  | n_shares | date_acquired <br>----------+----------+---------------<br> IBM      |     1000 | 2016-01-01<br> ibm      |     1000 | 2016-01-01<br> apple    |     1000 | 2016-01-01<br> google   |     1000 | 2016-01-01<br> ALPHABET |     1000 | 2016-01-01<br>(5 rows)<br><br>admin1=# insert into newly_acquired_stocks select * from my_stocks limit 3;<br>INSERT 0 3<br>admin1=# \d newly_acquired_stocks <br>       Table "public.newly_acquired_stocks"<br>    Column     |         Type          | Modifiers <br>---------------+-----------------------+-----------<br> symbol        | character varying(20) | not null<br> n_shares      | integer               | not null<br> date_acquired | date                  | not null<br><br>admin1=# select * from newly_acquired_stocks ;<br> symbol | n_shares | date_acquired <br>--------+----------+---------------<br> IBM    |     1000 | 2016-01-01<br> ibm    |     1000 | 2016-01-01<br> apple  |     1000 | 2016-01-01<br>(3 rows)<br><br>admin1=# <br><br>admin1=# select (count(*)/2) from my_stocks ;<br> ?column? <br>----------<br>        2<br>(1 row)<br><br>admin1=# select * from my_stocks where limit (select (count(*)/2) from my_stocks );<br>ERROR:  syntax error at or near "limit"<br>LINE 1: select * from my_stocks where limit (select (count(*)/2) fro...<br>                                      ^<br>admin1=# select * from my_stocks limit (select (count(*)/2) from my_stocks ); symbol | n_shares | date_acquired <br>--------+----------+---------------<br> IBM    |     1000 | 2016-01-01<br> ibm    |     1000 | 2016-01-01<br>(2 rows)<br><br>admin1=# select * from newly_acquired_stocks ;<br> symbol | n_shares | date_acquired <br>--------+----------+---------------<br> IBM    |     1000 | 2016-01-01<br> ibm    |     1000 | 2016-01-01<br> apple  |     1000 | 2016-01-01<br>(3 rows)<br><br>admin1=# delete from newly_acquired_stocks ;<br>DELETE 3<br>admin1=# select * from newly_acquired_stocks ;<br> symbol | n_shares | date_acquired <br>--------+----------+---------------<br>(0 rows)<br><br>admin1=# insert into newly_acquired_stocks select * from my_stocks limit (select (count(*)/2) from my_stocks );<br>INSERT 0 2<br>admin1=# select * from newly_acquired_stocks ; symbol | n_shares | date_acquired <br>--------+----------+---------------<br> IBM    |     1000 | 2016-01-01<br> ibm    |     1000 | 2016-01-01<br>(2 rows)<br><br>admin1=#
</p>
<hr>
<h3>Point 9</h3>
<p>
  admin1=# select * from my_stocks ;<br>  symbol  | n_shares | date_acquired <br>----------+----------+---------------<br> IBM      |     1000 | 2016-01-01<br> ibm      |     1000 | 2016-01-01<br> apple    |     1000 | 2016-01-01<br> google   |     1000 | 2016-01-01<br> ALPHABET |     1000 | 2016-01-01<br>(5 rows)<br><br>admin1=# select * from stock_prices ;<br>  symbol  | quote_date | price  <br>----------+------------+--------<br> IBM      | 2016-08-31 | 33.415<br> ibm      | 2016-08-31 | 33.415<br> apple    | 2016-08-31 | 33.415<br> google   | 2016-08-31 | 33.415<br> ALPHABET | 2016-08-31 | 33.415<br>(5 rows)<br><br>admin1=# select * from stock_prices A, my;<br><br>admin1=# select * from stock_prices A, my;<br><br>admin1=# select a.symbol, b.n_shares, a.price from stock_prices a, my_stocks b where a.symbol = b.symbol;<br>  symbol  | n_shares | price  <br>----------+----------+--------<br> IBM      |     1000 | 33.415<br> ibm      |     1000 | 33.415<br> apple    |     1000 | 33.415<br> google   |     1000 | 33.415<br> ALPHABET |     1000 | 33.415<br>(5 rows)
</p>
<hr>
<h3>Point 10</h3>
<p>
  admin1=# select * from my_stocks ;<br>  symbol  | n_shares | date_acquired <br>----------+----------+---------------<br> IBM      |     1000 | 2016-01-01<br> ibm      |     1000 | 2016-01-01<br> apple    |     1000 | 2016-01-01<br> google   |     1000 | 2016-01-01<br> ALPHABET |     1000 | 2016-01-01<br> SCG      |      200 | 2016-09-01<br>(6 rows)<br><br>admin1=# select * from stock_prices ;<br>  symbol  | quote_date | price  <br>----------+------------+--------<br> IBM      | 2016-08-31 | 33.415<br> ibm      | 2016-08-31 | 33.415<br> apple    | 2016-08-31 | 33.415<br> google   | 2016-08-31 | 33.415<br> ALPHABET | 2016-08-31 | 33.415<br>(5 rows)<br><br>admin1=# select b.symbol, b.n_shares, a.price from stock_prices a RIGHT OUTER JOIN my_stocks b ON a.symbol = b.symbol;<br>  symbol  | n_shares | price  <br>----------+----------+--------<br> IBM      |     1000 | 33.415<br> ibm      |     1000 | 33.415<br> apple    |     1000 | 33.415<br> google   |     1000 | 33.415<br> ALPHABET |     1000 | 33.415<br> SCG      |      200 |       <br>(6 rows)
</p>
<hr>
<h3>Point 11</h3>
<p>
  admin1=# CREATE OR REPLACE FUNCTION stock_price (symbol varchar)<br>RETURNS integer AS $total$<br>declare<br>total integer;<br>BEGIN<br>        select ascii(symbol) into total;<br>END;<br>$total$ LANGUAGE plpgsql;<br>CREATE FUNCTION<br>admin1=# \df<br>                              List of functions<br> Schema |    Name     | Result data type |   Argument data types    |  Type  <br>--------+-------------+------------------+--------------------------+--------<br> public | stock_price | integer          | symbol character varying | normal<br> public | total       | integer          |                          | normal<br>(2 rows)<br><br>admin1=# <br><br>admin1'# REPLACE FUNCTION stock_price (symbol varchar)<br>RETURNS integer AS $total$<br>declare<br>total integer;<br>BEGIN<br>        select ascii(symbol) into total; retunr total;<br>END;<br>$total$ LANGUAGE plpgsql;<br><br>                           ^<br>admin1=# select stock_price('I');<br> stock_price <br>-------------<br>          73<br>(1 row)<br><br>admin1=# select stock_price('B');<br> stock_price <br>-------------<br>          66<br>(1 row)<br><br>admin1=# <br><br>admin1=# create or REPLACE FUNCTION stock_price_function (symbol varchar)<br>RETURNS integer AS $total$<br>declare<br>total integer := 0; total_temp integer := 0; i integer := 1;<br>BEGIN<br>       while i <= char_length(symbol)  loop select ascii(substring(symbol from i for 1)) into total_temp; total := total + total_temp ; i := i + 1; end loop ; return total;<br>END;<br>$total$ LANGUAGE plpgsql;<br>CREATE FUNCTION<br>admin1=# select stock_price_function('ibm');<br> stock_price_function <br>----------------------<br>                  312<br>(1 row)<br><br>admin1=# select stock_price_function('IBM');<br> stock_price_function <br>----------------------<br>                  216<br>(1 row)<br><br>admin1=# <br><br>admin1=# select symbol, stock_price_function(symbol) from stock_prices;  symbol  | stock_price_function <br>----------+----------------------<br> IBM      |                  216<br> ibm      |                  312<br> apple    |                  530<br> google   |                  637<br> ALPHABET |                  577<br>(5 rows)<br><br>admin1=# <br><br><br>admin1=# update stock_prices set price = b.price from (select symbol, stock_price_function(symbol) as price from stock_prices) as b where symbol = b.symbol;<br>ERROR:  column reference "symbol" is ambiguous<br>LINE 1: ...on(symbol) as price from stock_prices) as b where symbol = b...<br>                                                             ^<br>admin1=# update stock_prices set price = b.price from (select symbol, stock_price_function(symbol) as price from stock_prices) as b where stock_prices.symbol = b.symbol;<br>UPDATE 5<br>admin1=# select * from stock_prices ;<br>  symbol  | quote_date | price <br>----------+------------+-------<br> IBM      | 2016-08-31 |   216<br> ibm      | 2016-08-31 |   312<br> apple    | 2016-08-31 |   530<br> google   | 2016-08-31 |   637<br> ALPHABET | 2016-08-31 |   577<br>(5 rows)<br><br>admin1=# <br><br>admin1=# select a.symbol, (a.n_shares*b.price) as aggregate_value from my_stocks a, stock_prices b where a.symbol = b.symbol;<br>  symbol  | aggregate_value <br>----------+-----------------<br> IBM      |          216000<br> ibm      |          312000<br> apple    |          530000<br> google   |          637000<br> ALPHABET |          577000<br>(5 rows)<br><br>admin1=# <br><br>admin1=# select a.symbol, (a.n_shares*b.price) as aggregate_value from my_stocks a LEFT OUTER JOIN stock_prices b ON a.symbol = b.symbol;<br>  symbol  | aggregate_value <br>----------+-----------------<br> IBM      |          216000<br> ibm      |          312000<br> apple    |          530000<br> google   |          637000<br> ALPHABET |          577000<br> SCG      |                <br>(6 rows)<br><br><br>admin1=# create or REPLACE FUNCTION porfolio_value()<br>admin1-# RETURNS integer AS $total$<br>admin1$# declare<br>admin1$# total integer := 0;<br>admin1$# stock_rec   RECORD;<br>admin1$# cursor_portfolio cursor for select a.symbol, b.n_shares, a.price from stock_prices a INNER JOIN my_stocks b ON a.symbol = b.symbol;<br>admin1$# <br>admin1$# BEGIN<br>admin1$#       open cursor_portfolio;<br>admin1$#      loop<br>admin1$#          fetch cursor_portfolio into stock_rec;<br>admin1$#          exit when not found;<br>admin1$#          total := total + (stock_rec.n_shares * stock_rec.price);<br>admin1$#      end loop;<br>admin1$#      close cursor_portfolio; return total;<br>admin1$# END;<br>admin1$# $total$ LANGUAGE plpgsql;<br>CREATE FUNCTION<br><br>admin1=# select sum( b.n_shares * a.price) from stock_prices a INNER JOIN my_stocks b ON a.symbol = b.symbol;<br>   sum   <br>---------<br> 4016000<br>(1 row)<br><br>admin1=# select porfolio_value() ;<br> porfolio_value <br>----------------<br>        4016000<br>(1 row)
</p>
<hr>
<h3>Point 12</h3>
<p>
  admin1=# select b.price from my_stocks a, stock_prices b where a.symbol = b.symbol;<br> price <br>-------<br>   216<br>   312<br>   530<br>   637<br>   577<br>(5 rows)<br><br>admin1=# select avg(b.price) from my_stocks a, stock_prices b where a.symbol = b.symbol;<br>  avg  <br>-------<br> 454.4<br>(1 row)<br><br>admin1=# <br><br>admin1=# select * from my_stocks ;<br>  symbol  | n_shares | date_acquired <br>----------+----------+---------------<br> IBM      |     1000 | 2016-01-01<br> ibm      |     1000 | 2016-01-01<br> apple    |     1000 | 2016-01-01<br> google   |     1000 | 2016-01-01<br> ALPHABET |     1000 | 2016-01-01<br> SCG      |      200 | 2016-09-01<br>(6 rows)<br><br>admin1=# insert into my_stocks (SELECT b.symbol,c.n_shares,CURRENT_DATE from (select avg(b.price) as price from my_stocks a, stock_prices b where a.symbol = b.symbol) as a , stock_prices b, my_stocks as c where b.symbol = c.symbol and b.price > a.price) ;<br>INSERT 0 3<br>admin1=# select * from my_stocks ;<br>  symbol  | n_shares | date_acquired <br>----------+----------+---------------<br> IBM      |     1000 | 2016-01-01<br> ibm      |     1000 | 2016-01-01<br> apple    |     1000 | 2016-01-01<br> google   |     1000 | 2016-01-01<br> ALPHABET |     1000 | 2016-01-01<br> SCG      |      200 | 2016-09-01<br> apple    |     1000 | 2016-09-04<br> google   |     1000 | 2016-09-04<br> ALPHABET |     1000 | 2016-09-04<br>(9 rows)<br><br>admin1=# <br>admin1=# select b.symbol, b.n_shares, a.price from stock_prices a RIGHT OUTER JOIN my_stocks b ON a.symbol = b.symbol;<br>  symbol  | n_shares | price <br>----------+----------+-------<br> IBM      |     1000 |   216<br> ibm      |     1000 |   312<br> apple    |     1000 |   530<br> google   |     1000 |   637<br> ALPHABET |     1000 |   577<br> SCG      |      200 |      <br> apple    |     1000 |   530<br> google   |     1000 |   637<br> ALPHABET |     1000 |   577<br>(9 rows)<br><br>admin1=# <br>admin1=# select * from my_stocks ;<br>  symbol  | n_shares | date_acquired <br>----------+----------+---------------<br> IBM      |     1000 | 2016-01-01<br> ibm      |     1000 | 2016-01-01<br> apple    |     1000 | 2016-01-01<br> google   |     1000 | 2016-01-01<br> ALPHABET |     1000 | 2016-01-01<br> SCG      |      200 | 2016-09-01<br> apple    |     1000 | 2016-09-04<br> google   |     1000 | 2016-09-04<br> ALPHABET |     1000 | 2016-09-04<br>(9 rows)<br><br>admin1=# select * from my_stocks group by symbol;<br>ERROR:  column "my_stocks.n_shares" must appear in the GROUP BY clause or be used in an aggregate function<br>LINE 1: select * from my_stocks group by symbol;<br>               ^<br>admin1=# select symbol from my_stocks group by symbol;<br>  symbol  <br>----------<br> ALPHABET<br> IBM<br> google<br> SCG<br> ibm<br> apple<br>(6 rows)<br><br>admin1=# select symbol,sum(n_shares) from my_stocks group by symbol;<br>  symbol  | sum  <br>----------+------<br> ALPHABET | 2000<br> IBM      | 1000<br> google   | 2000<br> SCG      |  200<br> ibm      | 1000<br> apple    | 2000<br>(6 rows)<br><br>admin1=# <br>admin1=# select a.symbol, (b.price * a.sum) as total_value from (select symbol,sum(n_shares) from my_stocks group by symbol) as a , stock_prices as b where a.symbol = b.symbol;<br>  symbol  | total_value <br>----------+-------------<br> IBM      |      216000<br> ibm      |      312000<br> apple    |     1060000<br> google   |     1274000<br> ALPHABET |     1154000<br>(5 rows)<br><br>admin1=# select * from stock_prices ;<br>  symbol  | quote_date | price <br>----------+------------+-------<br> IBM      | 2016-08-31 |   216<br> ibm      | 2016-08-31 |   312<br> apple    | 2016-08-31 |   530<br> google   | 2016-08-31 |   637<br> ALPHABET | 2016-08-31 |   577<br>(5 rows)<br><br>admin1=# select * from my_stocks ;<br>  symbol  | n_shares | date_acquired <br>----------+----------+---------------<br> IBM      |     1000 | 2016-01-01<br> ibm      |     1000 | 2016-01-01<br> apple    |     1000 | 2016-01-01<br> google   |     1000 | 2016-01-01<br> ALPHABET |     1000 | 2016-01-01<br> SCG      |      200 | 2016-09-01<br> apple    |     1000 | 2016-09-04<br> google   |     1000 | 2016-09-04<br> ALPHABET |     1000 | 2016-09-04<br>(9 rows)<br><br>admin1=# select a.symbol,a.sum as total_shares_held ,(a.sum * b.price) as total_value  from (select symbol, sum(n_shares)  from my_stocks group by symbol having count(symbol) > 1) as a , stock_prices as b where a.symbol = b.symbol;<br>  symbol  | total_shares_held | total_value <br>----------+-------------------+-------------<br> apple    |              2000 |     1060000<br> google   |              2000 |     1274000<br> ALPHABET |              2000 |     1154000<br>(3 rows)<br><br>admin1=#
</p>
<hr>
<h3>Point 13</h3>
<p>
  admin1=# <br>admin1=# CREATE VIEW stocks.i.like AS select a.symbol,a.sum as total_shares_held ,(a.sum * b.price) as total_value  from (select symbol, sum(n_shares)  from my_stocks group by symbol having count(symbol) > 1) as a , stock_prices as b where a.symbol = b.symbol;<br>ERROR:  cross-database references are not implemented: "stocks.i.like"<br>admin1=# CREATE VIEW stocks_i_like AS select a.symbol,a.sum as total_shares_held ,(a.sum * b.price) as total_value  from (select symbol, sum(n_shares)  from my_stocks group by symbol having count(symbol) > 1) as a , stock_prices as b where a.symbol = b.symbol;<br>CREATE VIEW<br>admin1=# select * from stocks_i_like ;<br>  symbol  | total_shares_held | total_value <br>----------+-------------------+-------------<br> apple    |              2000 |     1060000<br> google   |              2000 |     1274000<br> ALPHABET |              2000 |     1154000<br>(3 rows)<br><br>admin1=# <br>
</p>
<br>
<%= link_to "Return to PS2's page", basics2_index_path %>
<br>